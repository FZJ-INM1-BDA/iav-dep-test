name: "[siibra-api] [10min]"

on:
  schedule:
    - cron: '*/10 * * * *'
env:
  SIIBRA_MONITORING_SIIBRA_API: ${{ secrets.SIIBRA_MONITORING_SIIBRA_API }}
  CSCS_ENDPOINT: https://siibra-api-stable.apps.hbp.eu
  JSC_ENDPOINT: https://siibra-api-stable.apps.jsc.hbp.eu

jobs:

  api-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        endpoint: [cscs, jsc]
        use-cache: ["true", "false"]
        version: ['v1', 'v2', 'v3']

        exclude:
        - endpoint: jsc
          version: "v1"
    env:
      USE_CACHE: ${{ matrix.use-cache }}

    outputs:
      result-cscs-v1: ${{ steps.set-output.outputs.result-cscs-v1 }}
      result-cscs-v2: ${{ steps.set-output.outputs.result-cscs-v2 }}
      result-jsc-v2: ${{ steps.set-output.outputs.result-jsc-v2 }}
      result-cscs-v3: ${{ steps.set-output.outputs.result-cscs-v3 }}
      result-jsc-v3: ${{ steps.set-output.outputs.result-jsc-v3 }}
      
    steps:
    - name: Check out repository code
      uses: actions/checkout@v4
    - name: Set up Python 3.10
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'
    - name: Install dependencies
      run: |
        python -m pip install -U pip
        python -m pip install pytest requests nibabel
    - name: "Set endoint"
      run: |
        if [[ ${{ matrix.endpoint }} == "cscs" ]]
        then
          echo "SIIBRA_API_E2E_BASE_URL=${{ env.CSCS_ENDPOINT }}" >> $GITHUB_ENV
        fi
        if [[ ${{ matrix.endpoint }} == "jsc" ]]
        then
          echo "SIIBRA_API_E2E_BASE_URL=${{ env.JSC_ENDPOINT }}" >> $GITHUB_ENV
        fi
    - name: Run test
      run: |
        pytest ./siibra-api/${{ matrix.version }}
    - if: success()
      id: set-output
      name: Success, set output
      run: |
        if [ ${{ matrix.use-cache }} == true ]
        then
          echo "result-${{ matrix.endpoint }}-${{ matrix.version }}=true" >> $GITHUB_OUTPUT
        fi

  report-to-uptime:
    needs: api-test
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Check outputs
      run: |
        cscs_v1=${{ needs.api-test.outputs.result-cscs-v1 }}
        cscs_v2=${{ needs.api-test.outputs.result-cscs-v2 }}
        jsc_v2=${{ needs.api-test.outputs.result-jsc-v2 }}
        cscs_v3=${{ needs.api-test.outputs.result-cscs-v3 }}
        jsc_v3=${{ needs.api-test.outputs.result-jsc-v3 }}

        echo "cscs_v1: $cscs_v1"
        echo "cscs_v2: $cscs_v2"
        echo "jsc_v2: $jsc_v2"
        echo "cscs_v3: $cscs_v3"
        echo "jsc_v3: $jsc_v3"

        if [ -z "$cscs_v1" ] || [ -z "$cscs_v2" ] || [ -z "$jsc_v2" ] || [ -z "$cscs_v3" ] || [ -z "$jsc_v3" ]
        then
          exit -1
        fi
    - name: Report to monitoring
      if: success()
      run: |
        if [ ! -z "$SIIBRA_MONITORING_SIIBRA_API" ]
        then
          curl "$SIIBRA_MONITORING_SIIBRA_API"
        fi
